# ==============================================================================
# GitHub Actions Workflow - Z-Gate OS Build (Optimizado)
# ==============================================================================
# Usa imagen base pre-construida para builds rápidos
# ==============================================================================

name: Build Z-Gate OS (Optimized)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  # ==============================================================================
  # Job 1: Construir/Actualizar imagen base (solo cuando sea necesario)
  # ==============================================================================
  build-base-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      base-exists: ${{ steps.check.outputs.exists }}
      base-image: ${{ steps.repo.outputs.base_image }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set lowercase repository owner
        id: repo
        run: |
          echo "owner_lower=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          echo "base_image=ghcr.io/$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')/zgate-buildroot-base:latest" >> $GITHUB_OUTPUT
      
      - name: Check if base image exists
        id: check
        run: |
          if docker pull ${{ steps.repo.outputs.base_image }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Login to GitHub Container Registry
        if: steps.check.outputs.exists == 'false'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push base image
        if: steps.check.outputs.exists == 'false'
        run: |
          docker build -f Dockerfile.base -t ${{ steps.repo.outputs.base_image }} .
          docker push ${{ steps.repo.outputs.base_image }}
      
      - name: Scan base image for vulnerabilities
        if: steps.check.outputs.exists == 'false'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.repo.outputs.base_image }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results to GitHub Security
        if: steps.check.outputs.exists == 'false'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  # ==============================================================================
  # Job 2: Construir imagen pre-compilada (Buildroot output listo)
  # ==============================================================================
  build-compiled-image:
    needs: build-base-image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      compiled-exists: ${{ steps.check-compiled.outputs.exists }}
      compiled-image: ${{ steps.repo.outputs.compiled_image }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set image names
        id: repo
        run: |
          echo "compiled_image=ghcr.io/$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')/zgate-buildroot-compiled:latest" >> $GITHUB_OUTPUT
      
      - name: Check if compiled image exists
        id: check-compiled
        run: |
          if docker pull ${{ steps.repo.outputs.compiled_image }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Login to GitHub Container Registry
        if: steps.check-compiled.outputs.exists == 'false'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push compiled image (2 horas, solo primera vez)
        if: steps.check-compiled.outputs.exists == 'false'
        run: |
          docker build -f Dockerfile.compiled \
            --build-arg BASE_IMAGE=${{ needs.build-base-image.outputs.base-image }} \
            -t ${{ steps.repo.outputs.compiled_image }} .
          docker push ${{ steps.repo.outputs.compiled_image }}

  # ==============================================================================
  # Job 3: Build x86_64 ISO (5 min con imagen pre-compilada)
  # ==============================================================================
  build-x86_64:
    needs: build-compiled-image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Validate binary integrity
        run: |
          cd bin
          chmod +x validate.sh
          ./validate.sh
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build x86_64 ISO (usando imagen pre-compilada)
        run: |
          docker run --rm \
            -e TERM=linux \
            -v $(pwd)/bin:/workspace/bin:ro \
            -v $(pwd)/output:/buildroot/isos \
            ${{ needs.build-compiled-image.outputs.compiled-image }} x86_64
      
      - name: Upload x86_64 ISO
        uses: actions/upload-artifact@v4
        with:
          name: zgate-vultr-x86_64
          path: output/vultr-x86_64/
          retention-days: 30

  # ==============================================================================
  # Job 4: Build ARM64 Image (PARALELO - ejecuta simultáneamente con x86_64)
  # ==============================================================================
  build-arm64:
    needs: build-compiled-image  # Usa imagen pre-compilada
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Validate binary integrity
        run: |
          cd bin
          chmod +x validate.sh
          ./validate.sh
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build ARM64 Image (usando imagen pre-compilada)
        run: |
          docker run --rm \
            -e TERM=linux \
            -v $(pwd)/bin:/workspace/bin:ro \
            -v $(pwd)/output:/buildroot/isos \
            ${{ needs.build-compiled-image.outputs.compiled-image }} arm64
      
      - name: Upload ARM64 Image
        uses: actions/upload-artifact@v4
        with:
          name: zgate-oracle-arm64
          path: output/oracle-arm64/
          retention-days: 30

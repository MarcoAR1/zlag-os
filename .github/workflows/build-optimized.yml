# ==============================================================================
# GitHub Actions Workflow - Z-Gate OS Build (Optimizado)
# ==============================================================================
# Usa imagen base pre-construida para builds rápidos
# ==============================================================================

name: Build Z-Gate OS (Optimized)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  # ==============================================================================
  # Job 1: Construir/Actualizar imagen base (solo cuando sea necesario)
  # ==============================================================================
  build-base-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      base-exists: ${{ steps.check.outputs.exists }}
      base-image: ${{ steps.repo.outputs.base_image }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set lowercase repository owner
        id: repo
        run: |
          echo "owner_lower=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          echo "base_image=ghcr.io/$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')/zgate-buildroot-base:latest" >> $GITHUB_OUTPUT
      
      - name: Check if base image exists
        id: check
        run: |
          if docker pull ${{ steps.repo.outputs.base_image }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Login to GitHub Container Registry
        if: steps.check.outputs.exists == 'false'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push base image
        if: steps.check.outputs.exists == 'false'
        run: |
          docker build -f Dockerfile.base -t ${{ steps.repo.outputs.base_image }} .
          docker push ${{ steps.repo.outputs.base_image }}
      
      - name: Scan base image for vulnerabilities
        if: steps.check.outputs.exists == 'false'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.repo.outputs.base_image }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results to GitHub Security
        if: steps.check.outputs.exists == 'false'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  # ==============================================================================
  # Job 2: Build x86_64 ISO
  # ==============================================================================
  build-x86_64:
    needs: build-base-image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Validate binary integrity
        run: |
          cd bin
          chmod +x validate.sh
          ./validate.sh
      
      # ============================================================
      # CACHE AGRESIVO: Buildroot output (kernel + 200+ packages)
      # Invalida solo si cambian configs, NO por cambios en agente
      # ============================================================
      - name: Cache Buildroot x86_64 output
        uses: actions/cache@v5
        with:
          path: |
            buildroot/output/
            buildroot/dl/
          key: buildroot-x86_64-${{ hashFiles('buildroot/scripts/02_config.sh', 'buildroot/board/zgate/*.fragment', 'buildroot/configs/zgate_defconfig') }}
          restore-keys: |
            buildroot-x86_64-
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build x86_64 ISO
        env:
          ZGATE_SECRET: ${{ secrets.ZGATE_SECRET }}
        run: |
          docker build -f Dockerfile.build \
            --build-arg BASE_IMAGE=${{ needs.build-base-image.outputs.base-image }} \
            -t zgate-builder:x86_64 .
          
          docker run --rm \
            -e TERM=linux \
            -e ZGATE_SECRET="${ZGATE_SECRET}" \
            -v $(pwd)/output:/buildroot/isos \
            zgate-builder:x86_64 x86_64
      
      - name: Upload x86_64 ISO
        uses: actions/upload-artifact@v4
        with:
          name: zgate-vultr-x86_64
          path: output/vultr-x86_64/
          retention-days: 30

  # ==============================================================================
  # Job 3: Build ARM64 Image (PARALELO - ejecuta simultáneamente con x86_64)
  # ==============================================================================
  build-arm64:
    needs: build-base-image  # Solo depende de base, NO de x86_64 → builds paralelos (50% faster CI)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Validate binary integrity
        run: |
          cd bin
          chmod +x validate.sh
          ./validate.sh
      
      # ============================================================
      # CACHE AGRESIVO: Buildroot output (kernel + 200+ packages)
      # Invalida solo si cambian configs, NO por cambios en agente
      # ============================================================
      - name: Cache Buildroot ARM64 output
        uses: actions/cache@v5
        with:
          path: |
            buildroot/output_arm64/
            buildroot/dl/
          key: buildroot-arm64-${{ hashFiles('buildroot/scripts/02_config_arm.sh', 'buildroot/board/zgate/*.fragment', 'buildroot/configs/zgate_arm64_defconfig') }}
          restore-keys: |
            buildroot-arm64-
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build ARM64 Image
        env:
          ZGATE_SECRET: ${{ secrets.ZGATE_SECRET }}
        run: |
          docker build -f Dockerfile.build \
            --build-arg BASE_IMAGE=${{ needs.build-base-image.outputs.base-image }} \
            -t zgate-builder:arm64 .
          
          docker run --rm \
            -e TERM=linux \
            -e ZGATE_SECRET="${ZGATE_SECRET}" \
            -v $(pwd)/output:/buildroot/isos \
            zgate-builder:arm64 arm64
      
      - name: Upload ARM64 Image
        uses: actions/upload-artifact@v4
        with:
          name: zgate-oracle-arm64
          path: output/oracle-arm64/
          retention-days: 30

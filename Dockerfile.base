# ==============================================================================
# ðŸ—ï¸ Z-Gate Buildroot Base Image
# ==============================================================================
# Esta imagen se construye UNA VEZ y se reutiliza en todos los builds.
# Contiene Buildroot y todas las dependencias necesarias.
#
# Build:
#   docker build -f Dockerfile.base -t ghcr.io/tu-org/zgate-buildroot-base:latest .
#
# Push:
#   docker push ghcr.io/tu-org/zgate-buildroot-base:latest
# ==============================================================================

FROM ubuntu:22.04

# Evitar prompts interactivos
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC
ENV TERM=linux

# Variables de Buildroot
ENV BR2_DL_DIR=/buildroot/dl

# ==============================================================================
# Instalar dependencias de Buildroot
# ==============================================================================
RUN apt-get update && apt-get install -y \
    # Dependencias base de Buildroot
    build-essential \
    libncurses5-dev \
    git \
    bc \
    wget \
    cpio \
    unzip \
    rsync \
    file \
    python3 \
    python3-pip \
    # Cross-compilation para ARM64
    gcc-aarch64-linux-gnu \
    g++-aarch64-linux-gnu \
    # Herramientas adicionales
    vim \
    tree \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Configurar wget para ambientes corporativos
RUN echo "check_certificate = off" >> /etc/wgetrc

# ==============================================================================
# Descargar y preparar Buildroot
# ==============================================================================
WORKDIR /tmp
RUN wget https://buildroot.org/downloads/buildroot-2023.02.1.tar.gz && \
    tar xf buildroot-2023.02.1.tar.gz && \
    mv buildroot-2023.02.1 /buildroot && \
    rm buildroot-2023.02.1.tar.gz

# Crear directorios de cache
RUN mkdir -p /buildroot/dl && \
    mkdir -p /buildroot/output

# ==============================================================================
# Crear usuario builder
# ==============================================================================
RUN useradd -m -s /bin/bash builder && \
    echo "builder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    chown -R builder:builder /buildroot

WORKDIR /buildroot
USER builder

# Pre-cargar algunas dependencias comunes (opcional, acelera builds)
# RUN make menuconfig && make source

# Metadata
LABEL org.opencontainers.image.title="Z-Gate Buildroot Base"
LABEL org.opencontainers.image.description="Base image with Buildroot for Z-Gate OS builds"
LABEL org.opencontainers.image.version="1.0.0"
LABEL buildroot.version="2023.02.1"
LABEL kernel.version="6.1.100"
LABEL org.opencontainers.image.created="2026-01-23"
LABEL org.opencontainers.image.authors="Z-Gate Team"
LABEL org.opencontainers.image.source="https://github.com/zgate/zgate-os"

CMD ["/bin/bash"]

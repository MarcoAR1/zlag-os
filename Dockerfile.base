# ==============================================================================
# ðŸ—ï¸ zlag OS - Buildroot Base Image
# ==============================================================================
# Esta imagen es el cimiento de zlag. Contiene el toolchain y Buildroot.
# Reutilizada por los workers de GitHub Actions para builds ultra-rÃ¡pidos.
# ==============================================================================

FROM ubuntu:22.04

# ConfiguraciÃ³n de entorno y localizaciÃ³n
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC
ENV TERM=xterm-256color

# Variables crÃ­ticas de zlag / Buildroot
ENV BR2_DL_DIR=/zlag/dl
ENV BR2_JLEVEL=0
ENV FORCE_UNSAFE_CONFIGURE=1
ENV BR2_CCACHE=y
ENV BR2_CCACHE_DIR=/zlag/dl/ccache

# OptimizaciÃ³n de hilos para compilaciÃ³n
ENV MAKEFLAGS="-j$(($(nproc) + 1))"

# ==============================================================================
# Instalar dependencias estrictas (Kernel + Go Toolchain Support)
# ==============================================================================
RUN apt-get update && apt-get install -y \
    # Herramientas de compilaciÃ³n esenciales
    build-essential libncurses5-dev git bc wget cpio unzip rsync file \
    # Dependencias para Kernel 6.1+ (zlag core)
    libelf-dev libssl-dev flex bison \
    # Herramientas de descarga y cachÃ©
    ccache aria2 ca-certificates \
    # Cross-compilation para nodos zlag en ARM64 (Oracle Cloud)
    gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
    # AdministraciÃ³n mÃ­nima
    sudo \
    && rm -rf /var/lib/apt/lists/*

# ConfiguraciÃ³n de red para descargas de Buildroot
RUN echo "check_certificate = off" >> /etc/wgetrc

# ==============================================================================
# Preparar entorno zlag
# ==============================================================================
WORKDIR /tmp
RUN wget https://buildroot.org/downloads/buildroot-2023.02.1.tar.gz && \
    tar xf buildroot-2023.02.1.tar.gz && \
    mv buildroot-2023.02.1 /zlag && \
    rm buildroot-2023.02.1.tar.gz

# Crear estructura de directorios persistentes
RUN mkdir -p /zlag/dl /zlag/output /zlag/dl/ccache

# ==============================================================================
# Usuario de compilaciÃ³n (builder) para evitar permisos de root en el OS
# ==============================================================================
RUN useradd -m -s /bin/bash zlag-builder && \
    echo "zlag-builder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    chown -R zlag-builder:zlag-builder /zlag

WORKDIR /zlag
USER zlag-builder

# Volumen para que las descargas de paquetes no se pierdan entre builds
VOLUME ["/zlag/dl"]

# Metadata de Marca
LABEL org.opencontainers.image.title="zlag OS Base"
LABEL org.opencontainers.image.description="Minimalist Buildroot environment for zlag OS nodes"
LABEL zlag.version="1.0.0"
LABEL buildroot.version="2023.02.1"

CMD ["/bin/bash"]
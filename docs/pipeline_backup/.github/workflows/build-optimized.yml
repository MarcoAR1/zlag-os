name: Build Z-Lag OS (Smart Cache Multi-Arch)

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'buildroot/**'
      - 'bin/**'
      - 'configs/**'
      - 'scripts/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  # ==============================================================================
  # Job 1: Base Environment (Toolchain & Buildroot Core)
  # ==============================================================================
  build-base-image:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      packages: write
    outputs:
      base_image: ${{ steps.repo.outputs.base_image }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set base image name
        id: repo
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "base_image=ghcr.io/${OWNER_LC}/zlag-base:v1" >> $GITHUB_OUTPUT

      - name: Build and Push Base
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.base
          push: true
          tags: ${{ steps.repo.outputs.base_image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==============================================================================
  # Job 2: Buildroot Compiler (Kernel & System Segregation)
  # ==============================================================================
  build-compiled-image:
    needs: build-base-image
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        arch: [x86_64, arm64]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate Config Hash
        id: config-hash
        run: |
          # Incluimos Dockerfile.compiled en el hash para re-compilar si cambia la lógica de build
          HASH=$(find buildroot/scripts buildroot/configs buildroot/board Dockerfile.compiled -type f -print0 | sort -z | xargs -0 cat | sha256sum | head -c 16)
          echo "hash=${HASH}" >> $GITHUB_OUTPUT

      - name: Set Docker Metadata
        id: meta
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "full_tag=ghcr.io/${OWNER_LC}/zlag-compiled-${{ matrix.arch }}:${{ steps.config-hash.outputs.hash }}" >> $GITHUB_OUTPUT

      - name: Check if Image exists
        id: check
        run: |
          if docker pull ${{ steps.meta.outputs.full_tag }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build and Push Compiled Kernel
        if: steps.check.outputs.exists == 'false'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.compiled
          push: true
          tags: ${{ steps.meta.outputs.full_tag }}
          build-args: |
            BASE_IMAGE=${{ needs.build-base-image.outputs.base_image }}
            ARCH=${{ matrix.arch }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==============================================================================
  # Job 3: Final Assembly (Inyección de Binarios Específicos)
  # ==============================================================================
  assemble-final-iso:
    needs: build-compiled-image
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        arch: [x86_64, arm64]
        include:
          - arch: x86_64
            artifact_name: zlag-vultr-x86_64
            binary_src: bin/z-lag-agent-x86_64
          - arch: arm64
            artifact_name: zlag-oracle-arm64
            binary_src: bin/z-lag-agent-arm64

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate Hash
        id: config-hash
        run: |
          HASH=$(find buildroot/scripts buildroot/configs buildroot/board Dockerfile.compiled -type f -print0 | sort -z | xargs -0 cat | sha256sum | head -c 16)
          echo "hash=${HASH}" >> $GITHUB_OUTPUT

      - name: Assemble Final ISO
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          CALCULATED_HASH="${{ steps.config-hash.outputs.hash }}"
          KNOWN_GOOD_HASH="8188e8307c1eebca"
          
          BASE_IMG="ghcr.io/${OWNER_LC}/zlag-compiled-${{ matrix.arch }}"
          
          # Lógica de fallback para evitar que el pipeline muera por desincronización
          if docker pull "${BASE_IMG}:${CALCULATED_HASH}"; then
            FINAL_IMG="${BASE_IMG}:${CALCULATED_HASH}"
          else
            echo "⚠️ Hash calculado no encontrado, usando bypass estable..."
            FINAL_IMG="${BASE_IMG}:${KNOWN_GOOD_HASH}"
            docker pull "$FINAL_IMG"
          fi
          
          mkdir -p output/images
          
          # Inyectamos el binario específico de la arquitectura
          # El contenedor lo espera en /zlag/bin/z-lag-agent vía entrypoint
          docker run --rm \
            -v $(pwd)/${{ matrix.binary_src }}:/zlag/bin/z-lag-agent:ro \
            -v $(pwd)/output/images:/zlag/output/images \
            $FINAL_IMG

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: output/images/
          retention-days: 7
# ==============================================================================
# üê≥ Z-Gate Build Test Environment
# ==============================================================================
# Replica el ambiente de GitHub Actions para testear la generaci√≥n de ISOs
# localmente antes de hacer push al repositorio.
#
# Uso:
#   docker build -f Dockerfile.test -t zgate-builder:test .
#   docker run -v $(pwd):/workspace zgate-builder:test x86_64
#   docker run -v $(pwd):/workspace zgate-builder:test arm64
#   docker run -v $(pwd):/workspace zgate-builder:test both
# ==============================================================================

FROM ubuntu:22.04

# Evitar prompts interactivos
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC
ENV TERM=linux

# Variables de entorno para Buildroot
ENV BR2_DL_DIR=/workspace/buildroot/dl
ENV PATH="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"

# ==============================================================================
# Instalar dependencias de Buildroot (id√©nticas a GitHub Actions)
# ==============================================================================
RUN apt-get update && apt-get install -y \
    # Dependencias base de Buildroot
    build-essential \
    libncurses5-dev \
    git \
    bc \
    wget \
    cpio \
    unzip \
    rsync \
    file \
    python3 \
    python3-pip \
    # Cross-compilation para ARM64
    gcc-aarch64-linux-gnu \
    g++-aarch64-linux-gnu \
    # Herramientas adicionales para debugging
    vim \
    tree \
    htop \
    ncdu \
    # Herramientas de hash y checksums
    coreutils \
    && rm -rf /var/lib/apt/lists/*

# ==============================================================================
# Crear usuario no-root (Buildroot prefiere no ejecutarse como root)
# ==============================================================================
RUN useradd -m -s /bin/bash builder && \
    echo "builder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Configurar wget para ambientes corporativos con SSL inspection
RUN echo "check_certificate = off" >> /etc/wgetrc

# ==============================================================================
# Configurar directorio de trabajo
# ==============================================================================
WORKDIR /workspace

# Dar permisos al usuario builder sobre /workspace
RUN chown -R builder:builder /workspace

# ==============================================================================
# Script de entrada para testear builds
# ==============================================================================
COPY docker-test-entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# NO cambiar a usuario builder aqu√≠ - lo haremos en el entrypoint
# USER builder

# Exponer volumen para cache de descargas de Buildroot
VOLUME ["/workspace/buildroot/dl"]

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["both"]

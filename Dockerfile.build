# ==============================================================================
#  ZLAG OS - Monolithic Build System (i5-13600KF Optimized)
# ==============================================================================
ARG BASE_IMAGE=ghcr.io/marcoar1/zlag-base:v1
FROM ${BASE_IMAGE}

ARG ARCH
ENV ZLAG_ARCH=${ARCH}
ENV TERM=linux

USER root
WORKDIR /zlag

# 1. Preparaci贸n de Archivos (Sincronizaci贸n Total)
# ------------------------------------------------------------------------------
# Copiamos las carpetas desde la ra铆z del proyecto
COPY buildroot/ ./buildroot/
COPY bin/ ./bin/

# Aplanamos la estructura para que los scripts encuentren todo en /zlag/
RUN mv ./buildroot/* ./ && \
    mkdir -p /zlag/bin_agents && \
    cp ./bin/z-lag-agent-* /zlag/bin_agents/ && \
    chown -R zlag-builder:zlag-builder /zlag && \
    chmod +x /zlag/scripts/*.sh 2>/dev/null || true

# 2. Compilaci贸n e Inyecci贸n
# ------------------------------------------------------------------------------
USER zlag-builder
SHELL ["/bin/bash", "-c"]

RUN set -e && \
    source scripts/00_env.sh && \
    source scripts/01_deps.sh && \
    \
    if [ "${ZLAG_ARCH}" = "arm64" ]; then \
        echo "[锔] Configurando ARM64..." && \
        source scripts/02_config_arm.sh && \
        configure_system_arm && \
        make zlag_arm64_defconfig; \
    elif [ "${ZLAG_ARCH}" = "x86_64" ]; then \
        echo "[锔] Configurando x86_64..." && \
        source scripts/02_config.sh && \
        configure_system && \
        make zlag_defconfig; \
    fi && \
    \
    # Inyecci贸n del agente antes del build final
    echo "[] Inyectando agente Z-Lag para ${ZLAG_ARCH}..." && \
    mkdir -p output/target/usr/bin && \
    cp /zlag/bin_agents/z-lag-agent-${ZLAG_ARCH} output/target/usr/bin/z-lag-agent && \
    chmod +x output/target/usr/bin/z-lag-agent && \
    \
    # COMPILACIN TOTAL (A darle 谩tomos con 20 hilos)
    echo "[] Iniciando compilaci贸n total de Buildroot..." && \
    make -j$(nproc)

LABEL org.opencontainers.image.source="https://github.com/marcoar1/zlag-os"
CMD ["/bin/bash"]
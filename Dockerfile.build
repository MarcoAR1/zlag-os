# ==============================================================================
#  zlag OS - Compilador de Kernel y Sistema (Smart Cache Edition)
# ==============================================================================
# Esta imagen toma la base de zlag y compila el "esqueleto" del SO.
# ==============================================================================

ARG BASE_IMAGE=ghcr.io/marcoar1/zlag-base:v1
FROM ${BASE_IMAGE}

# Recibimos la arquitectura (x86_64 o arm64) desde el Workflow
ARG ARCH
ENV TARGET_ARCH=${ARCH}
ENV TERM=linux

USER root

# ==============================================================================
#  Sincronizaci贸n de Fuentes y Configuraci贸n
# ==============================================================================
# Nota: No copiamos 'bin/' aqu铆 para no romper el cach茅 del Kernel.
# El agente se inyectar谩 v铆a volumen en el Job de ensamblaje final.

WORKDIR /zlag

# Copiar solo lo necesario para configurar el Kernel y Buildroot
COPY buildroot/scripts/ ./scripts/
COPY buildroot/configs/ ./configs/
COPY buildroot/board/zlag/ ./board/zlag/ 
COPY buildroot/*.sh ./

# Asegurar permisos para el usuario builder de la imagen base
RUN chmod +x *.sh scripts/*.sh && \
    chown -R zlag-builder:zlag-builder /zlag

# ==============================================================================
#  Compilaci贸n del "Esqueleto" (Kernel + Toolchain)
# ==============================================================================
USER zlag-builder

RUN set -e && \
    source scripts/00_env.sh && \
    source scripts/01_deps.sh && \
    if [ "${TARGET_ARCH}" = "x86_64" ]; then \
        echo " Compilando base x86_64..." && \
        source scripts/02_config.sh && \
        configure_system && \
        make zlag_defconfig && \
        make -j$(nproc); \
    elif [ "${TARGET_ARCH}" = "arm64" ]; then \
        echo " Compilando base ARM64..." && \
        source scripts/02_config_arm.sh && \
        configure_system_arm && \
        make zlag_arm64_defconfig && \
        make -j$(nproc); \
    fi

# ==============================================================================
# Ч Limpieza Quir煤rgica
# ==============================================================================
# Eliminamos archivos pesados que no se necesitan para el empaquetado final,
# manteniendo los .stamp para que el 'make' futuro sea instant谩neo.
RUN rm -rf dl/* && \
    find output/build -name "*.o" -delete && \
    rm -rf output/build/host-*

# ==============================================================================
#  Entrypoint para Inyecci贸n y Ensamblaje
# ==============================================================================
USER root
COPY docker-build-entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

USER zlag-builder
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]